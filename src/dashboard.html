<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Service Health Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f7; margin: 0; padding: 20px; }
    h1 { margin-bottom: 20px; }
    .card { background: white; padding: 16px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .error { color: #b00020; }
    .ok { color: green; font-weight: bold; }
    .history { margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #ddd; padding: 6px; text-align: left; }
    .reload-btn { padding: 8px 12px; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Service Health Dashboard</h1>

  <button class="reload-btn" onclick="reloadConfig()">Reload Config</button>
  <p id="reloadStatus"></p>

  <div id="services"></div>

  <script>
    async function loadLatest() {
      const res = await fetch('/health');
      const data = await res.json();

      const servicesDiv = document.getElementById('services');
      servicesDiv.innerHTML = '';

      for (const service of Object.values(data)) {
        const card = document.createElement('div');
        card.className = 'card';

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
          <span><strong>${service.serviceName}</strong></span>
          <span class="${service.ok ? 'ok' : 'error'}">${service.ok ? 'OK' : 'DOWN'}</span>
        `;
        card.appendChild(header);

        const info = document.createElement('div');
        info.innerHTML = `
          <p>Status Code: ${service.statusCode ?? 'N/A'}</p>
          <p>Latency: ${service.latency} ms</p>
          <p>Version: ${service.version ?? 'N/A'}</p>
          <p>Expected Version: ${service.expectedVersion}</p>
        `;
        card.appendChild(info);

        await loadHistory(service.serviceName, card);
        servicesDiv.appendChild(card);
      }
    }

    async function loadHistory(name, card) {
      const res = await fetch(`/health/${name}`);
      const rows = await res.json();

      const historyDiv = document.createElement('div');
      historyDiv.className = 'history';

      if (!Array.isArray(rows)) {
        historyDiv.innerHTML = `<p class="error">No history found</p>`;
        card.appendChild(historyDiv);
        return;
      }

      const table = document.createElement('table');
      table.innerHTML = `
        <tr>
          <th>Time</th><th>Status</th><th>Latency</th><th>Error</th>
        </tr>
      `;

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(row.timestamp).toLocaleString()}</td>
          <td>${row.ok ? 'OK' : 'DOWN'}</td>
          <td>${row.latency} ms</td>
          <td>${row.error || ''}</td>
        `;
        table.appendChild(tr);
      });

      historyDiv.appendChild(table);
      card.appendChild(historyDiv);
    }

    async function reloadConfig() {
      const res = await fetch('/services/reload', { method: 'POST' });
      const data = await res.json();
      document.getElementById('reloadStatus').textContent =
        `Config reloaded. Services: ${data.serviceCount}`;
      loadLatest();
    }

    loadLatest();
    setInterval(loadLatest, 5000);
  </script>
</body>
</html>
